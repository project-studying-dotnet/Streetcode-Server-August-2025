name: SonarCloud
on:
  push:
    branches: [ main, dev ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build:
    name: Build and analyze
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Потрібні обидва SDK (проект net6.0, інструмент вимагає net8.0)
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # PATH для глобальних dotnet tools (Windows)
      - name: Ensure dotnet tools PATH
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install tools
        run: |
          dotnet tool install --global dotnet-coverage
          dotnet tool install --global dotnet-sonarscanner

      - name: SonarScanner Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          dotnet sonarscanner begin
          /k:"project-studying-dotnet_Streetcode-Server-August-2025"
          /o:"project-studying-dotnet"
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
          /d:sonar.host.url="https://sonarcloud.io"
          /d:sonar.cs.vscoveragexml.reportsPaths="**/coverage.xml"

      - name: Restore
        run: dotnet restore ./Streetcode/Streetcode.sln

      - name: Build
        run: dotnet build ./Streetcode/Streetcode.sln --configuration Release --no-restore

      - name: Test and Code Coverage (VSCoverage XML)
        run: >
          dotnet-coverage collect
          "dotnet test ./Streetcode/Streetcode.XUnitTest/Streetcode.XUnitTest.csproj
          --configuration Release --results-directory ./coverage
          --logger trx;LogFileName=test-results.trx"
          -f xml -o coverage.xml

      - name: SonarScanner End
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Save Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/*.trx"

  test-report:
    name: Test Results
    runs-on: windows-latest
    needs: build
    if: always()
    steps:
      - uses: dorny/test-reporter@v2
        with:
          name: Test results
          artifact: test-results
          path: "**/*.trx"
          reporter: dotnet-trx
          list-suites: failed
          list-tests: failed
          fail-on-error: true

